<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quiz</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      margin: 0;
      transition: background 0.3s, color 0.3s;
    }
    .dark {
      background: #121212;
      color: #eee;
    }
    .sidebar {
      width: 100px;
      background: #fff;
      border-right: 1px solid #ddd;
      padding: 10px;
      overflow-y: auto;
    }
    .dark .sidebar {
      background: #1e1e1e;
      border-color: #444;
    }
    #palette button {
      margin: 5px;
      width: 40px;
      height: 40px;
    }
    .main {
      padding: 20px;
      flex: 1;
    }
    .question { font-size: 1.1em; margin-bottom: 10px; }
    .image { max-width: 100%; margin-bottom: 20px; display: none; }
    .options button {
      display: block;
      margin: 10px 0;
      padding: 10px;
      width: 100%;
      font-size: 1em;
    }
    .correct { background: #c8e6c9; }
    .wrong { background: #ffcdd2; }
    .summary {
      margin-top: 20px;
      padding: 10px;
      background: #f4f4f4;
      border-radius: 8px;
    }
    .dark .summary {
      background: #2b2b2b;
    }
    #toggle-dark {
      position: fixed;
      top: 10px;
      right: 10px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dark">
  <div class="sidebar">
    <h4>Palette</h4>
    <div id="palette"></div>
  </div>
  <div class="main">
    <div id="question-number"></div>
    <div id="question-text" class="question"></div>
    <img id="question-image" class="image" />
    <div id="options" class="options"></div>
    <p id="timer">Time: 0 sec</p>
    <button onclick="prevQuestion()">‚¨ÖÔ∏è Prev</button>
    <button onclick="nextQuestion()">Next ‚û°Ô∏è</button>
    <button onclick="submitQuiz()">‚úÖ Submit Quiz</button>
    <button onclick="resetQuiz()">üîÑ Retry</button>
    <button onclick="location.href='index.html'">üè† Home</button>
    <div id="result-summary" class="summary"></div>
  </div>
  <button id="toggle-dark" onclick="toggleDarkMode()">‚òÄÔ∏è</button>

  <script>
    // Restore saved dark mode
    if (localStorage.getItem("dark") === "false") {
      document.body.classList.remove("dark");
      document.getElementById("toggle-dark").textContent = "üåô";
    }
    function toggleDarkMode() {
      const isDark = document.body.classList.toggle("dark");
      localStorage.setItem("dark", isDark);
      document.getElementById("toggle-dark").textContent = isDark ? "‚òÄÔ∏è" : "üåô";
    }
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAMNDoNuqkWfXEGYdwueJb5XTr1ST2ztKc",
      authDomain: "mcqs-96117.firebaseapp.com",
      projectId: "mcqs-96117",
      storageBucket: "mcqs-96117.firebasestorage.app",
      messagingSenderId: "352256319143",
      appId: "1:352256319143:web:74b2bd062a7f2dc5f1c582",
      measurementId: "G-6FZ770H045"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const urlParams = new URLSearchParams(window.location.search);
    const subject = urlParams.get('subject') || 'Anatomy';

    let questions = [];
    let current = 0;
    let selectedAnswers = [];
    let startTime = Date.now();
    let timerInterval;

    const qText = document.getElementById("question-text");
    const qImage = document.getElementById("question-image");
    const qOptions = document.getElementById("options");
    const qNumber = document.getElementById("question-number");
    const palette = document.getElementById("palette");
    const resultDiv = document.getElementById("result-summary");
    const timer = document.getElementById("timer");

    // Load quiz questions from Firestore
    async function loadQuiz() {
      const docRef = doc(db, "questions", subject);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        questions = docSnap.data().questions;
        selectedAnswers = new Array(questions.length);
        loadQuestion(0);
        timerInterval = setInterval(updateTimer, 1000);
      } else {
        alert("No questions found for this subject.");
      }
    }

    // Load question function
    function loadQuestion(index) {
      current = index;
      const q = questions[index];
      qNumber.textContent = `Question ${index + 1}`;
      qText.textContent = q.question;
      qImage.style.display = q.image ? "block" : "none";
      qImage.src = q.image || "";
      qOptions.innerHTML = "";

      q.options.forEach((opt, i) => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.onclick = () => selectAnswer(i, btn);
        qOptions.appendChild(btn);
      });

      renderPalette();
    }

    // Handle answer selection
    function selectAnswer(selectedIndex, btn) {
      const q = questions[current];
      const isCorrect = selectedIndex === q.answer;
      selectedAnswers[current] = { selectedIndex, correct: isCorrect };

      const buttons = qOptions.querySelectorAll("button");
      buttons.forEach((b, i) => {
        b.disabled = true;
        if (i === q.answer) b.classList.add("correct");
        if (i === selectedIndex && !isCorrect) b.classList.add("wrong");
      });

      saveProgress();
      renderPalette();
    }

    // Save progress
    function saveProgress() {
      const key = `progress_${subject}`;
      const summary = {
        attempted: selectedAnswers.filter(a => a !== undefined).length,
        correct: selectedAnswers.filter(a => a && a.correct).length,
        wrong: selectedAnswers.filter(a => a && !a.correct).length,
        total: questions.length,
        answers: selectedAnswers
      };
      localStorage.setItem(key, JSON.stringify(summary));
    }

    // Render the question palette
    function renderPalette() {
      palette.innerHTML = "";
      questions.forEach((_, i) => {
        const btn = document.createElement("button");
        btn.textContent = i + 1;
        btn.onclick = () => loadQuestion(i);
        if (selectedAnswers[i] !== undefined) {
          btn.style.background = selectedAnswers[i].correct ? "#66bb6a" : "#ef5350";
        }
        palette.appendChild(btn);
      });
    }

    // Timer update
    function updateTimer() {
      const diff = Math.floor((Date.now() - startTime) / 1000);
      const mins = Math.floor(diff / 60);
      const secs = diff % 60;
      timer.textContent = `Time: ${mins}m ${secs}s`;
    }

    // Submit the quiz and show results
    function submitQuiz() {
      let correct = 0, wrong = 0, attempted = 0;
      selectedAnswers.forEach(a => {
        if (a !== undefined) {
          attempted++;
          if (a.correct) correct++;
          else wrong++;
        }
      });
      const unattempted = questions.length - attempted;
      const score = correct * 4 - wrong;

      const timeTaken = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(timeTaken / 60);
      const seconds = timeTaken % 60;

      resultDiv.innerHTML = `
        <h3>Quiz Summary</h3>
        <p>‚úÖ Correct: ${correct}</p>
        <p>‚ùå Wrong: ${wrong}</p>
        <p>‚è≥ Unattempted: ${unattempted}</p>
        <p>üßÆ Score: ${score} / ${questions.length * 4}</p>
        <p>‚è±Ô∏è Time Taken: ${minutes} min ${seconds} sec</p>
        <canvas id="resultChart" width="300" height="300"></canvas>
      `;

      new Chart(document.getElementById("resultChart"), {
        type: "pie",
        data: {
          labels: ["Correct", "Wrong", "Unattempted"],
          datasets: [{
            data: [correct, wrong, unattempted],
            backgroundColor: ["#66bb6a", "#ef5350", "#ffee58"]
          }]
        },
        options: {
          responsive: false,
          plugins: {
            legend: {
              position: "bottom"
            }
          }
        }
      });

      clearInterval(timerInterval);
      renderPalette();
    }

    // Check user authentication state and load the quiz
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loadQuiz();
      } else {
        alert("‚ùå Please login to access this quiz.");
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>
