<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <script type="module">
    // --- Firebase Imports (v10 Modular) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      GoogleAuthProvider, 
      OAuthProvider, 
      signInWithRedirect, 
      onAuthStateChanged, 
      signOut 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      doc, 
      setDoc, 
      getDoc, 
      getDocs 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyAMNDoNuqkWfXEGYdwueJb5XTr1ST2ztKc",
      authDomain: "mcqs-96117.firebaseapp.com",
      projectId: "mcqs-96117",
      storageBucket: "mcqs-96117.firebasestorage.app",
      messagingSenderId: "352256319143",
      appId: "1:352256319143:web:74b2bd062a7f2dc5f1c582",
      measurementId: "G-6FZ770H045"
    };

    // --- Initialize ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Login Functions ---
    window.emailLogin = function() {
      const email = document.getElementById("loginEmail").value;
      const pass = document.getElementById("loginPassword").value;
      signInWithEmailAndPassword(auth, email, pass).catch(err => alert(err.message));
    }

    window.googleLogin = function() {
      const provider = new GoogleAuthProvider();
      signInWithRedirect(auth, provider);
    }

    window.appleLogin = function() {
      const provider = new OAuthProvider('apple.com');
      signInWithRedirect(auth, provider);
    }

    // --- Auth State ---
    onAuthStateChanged(auth, user => {
      if (user && user.email === "y3knishu@gmail.com") {
        document.getElementById("login-section").style.display = "none";
        document.getElementById("admin-section").style.display = "block";
        loadUsers();
        loadVisitStats();
        setInterval(loadVisitStats, 10000); // auto-refresh every 10s
      } else if (user) {
        alert("Access denied. Not admin.");
        signOut(auth);
      }
    });

    // --- Add User ---
    window.addUser = async function() {
      const userId = document.getElementById("newUserId").value.trim();
      const email = document.getElementById("newUserEmail").value.trim();
      const phone = document.getElementById("newUserPhone").value.trim();
      const paidStatus = document.getElementById("newUserPaid").value;

      if (!userId) {
        alert("User ID is required");
        return;
      }

      let dataToSave = {};
      if (email) dataToSave.email = email;
      if (phone) dataToSave.phone = phone;
      if (paidStatus) {
        dataToSave.isPaid = paidStatus === "Paid"; 
      }

      await setDoc(doc(db, "users", userId), dataToSave, { merge: true });
      alert("User added/updated successfully");
      document.getElementById("newUserId").value = "";
      document.getElementById("newUserEmail").value = "";
      document.getElementById("newUserPhone").value = "";
      document.getElementById("newUserPaid").value = "";
      loadUsers();
    }

    // --- Load Users ---
    async function loadUsers() {
      const tbody = document.querySelector("#usersTable tbody");
      tbody.innerHTML = "";
      const querySnapshot = await getDocs(collection(db, "users"));
      querySnapshot.forEach(docSnap => {
        const user = docSnap.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${docSnap.id}</td>
          <td>${user.email || ""}</td>
          <td>${user.phone || ""}</td>
          <td>${user.isPaid ? "Paid" : "Unpaid"}</td>
          <td>
            <select onchange="updatePaymentStatus('${docSnap.id}', this.value)">
              <option value="Paid" ${user.isPaid ? "selected" : ""}>Paid</option>
              <option value="Unpaid" ${!user.isPaid ? "selected" : ""}>Unpaid</option>
            </select>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // --- Update Payment Status ---
    window.updatePaymentStatus = async function(userId, status) {
      const isPaid = status === "Paid";  
      await setDoc(doc(db, "users", userId), { isPaid }, { merge: true });
    }

    // --- Load Visit Stats ---
    async function loadVisitStats() {
      const today = new Date().toISOString().split("T")[0];
      const todayRef = doc(db, "visits", today);

      try {
        // Today‚Äôs visits
        const todaySnap = await getDoc(todayRef);
        if (todaySnap.exists()) {
          document.getElementById("todayVisits").textContent = todaySnap.data().count;
        } else {
          document.getElementById("todayVisits").textContent = "0";
        }

        // Total visits
        const allDocs = await getDocs(collection(db, "visits"));
        let total = 0;
        allDocs.forEach(d => total += d.data().count);
        document.getElementById("totalVisits").textContent = total;

        // Last updated
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
        document.getElementById("lastUpdated").textContent = `‚úÖ Last updated at ${timeStr}`;
      } catch (e) {
        console.error("Error loading visits:", e);
      }
    }
  </script>
</head>
<body>
  <h2>Admin Login</h2>
  <div id="login-section">
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Password">
    <button onclick="emailLogin()">Login with Email</button>
    <br><br>
    <button onclick="googleLogin()">Login with Google</button>
    <button onclick="appleLogin()">Login with Apple</button>
  </div>

  <div id="admin-section" style="display:none;">
    <h2>Admin Dashboard</h2>

    <!-- üîπ Visits Statistics -->
    <h3>Visits Statistics</h3>
    <p>üìÖ Today‚Äôs Visits: <span id="todayVisits">0</span></p>
    <p>üåç Total Visits: <span id="totalVisits">0</span></p>
    <small id="lastUpdated">‚è≥ Loading...</small>
    <hr>

    <h3>Add New User</h3>
    <input type="text" id="newUserId" placeholder="User ID">
    <input type="email" id="newUserEmail" placeholder="Email">
    <input type="text" id="newUserPhone" placeholder="Phone">
    <select id="newUserPaid">
      <option value="">Select Payment Status</option>
      <option value="Paid">Paid</option>
      <option value="Unpaid">Unpaid</option>
    </select>
    <button onclick="addUser()">Add User</button>

    <h3>All Users</h3>
    <table border="1" id="usersTable">
      <thead>
        <tr>
          <th>User ID</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Payment Status</th>
          <th>Change Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</body>
</html>
